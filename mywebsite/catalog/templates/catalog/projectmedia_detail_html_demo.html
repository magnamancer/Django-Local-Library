{% extends "generic.html" %}


{% block title %}
    {{ projectmedia.title }} - Interactive Demo
{% endblock %}

{% block content %}
    <div id="main" class="alt">
        <section id="one">
            <div class="inner">
                <header class="major">
                    <h1>{{ projectmedia.title }}</h1>
                </header>
                <div class="row justify-content-center">
                    <div class="col-12 col-md-8"> {# Chart takes 12 cols on small, 8 on medium+ #}
                        <div id="plotly-chart" style="width:50%; height:600px;"></div>
                    </div>
                 </div>
            	 <div class="row">
                     <div class="col-md-4">
                         <form method="post">
                            {% csrf_token %}
                            {% for field in form.visible_fields %}
                                <div class="my-custom-field-wrapper">
                                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                    {{ field }} {# Renders the input/select/textarea itself #}
                                </div>
                            {% endfor %}
                            <button type="submit">Submit</button>
                          </form>
                         {% if interactive_demo_data.x_var_selected and interactive_demo_data.y_var_selected %}
                             <p class="mt-3">
                                 <strong>Current Plot:</strong>
                                 {{ interactive_demo_data.y_var_selected|capfirst}} vs. {{ interactive_demo_data.x_var_selected|capfirst}}
                             </p>
                         {% endif %}
                     </div>
                  </div>
	</div>
{% endblock %}

{% block extra_head %}
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
{% endblock %}

{% block extra_js %}
    <script id="plotly-data-json" type="application/json">
        {{ interactive_demo_data.plotly_data|safe }}
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Finding element where plot is to be plotted
            var chartDiv = document.getElementById('plotly-chart');
            // load json that has plotly data in it
            var plotlyJsonElement = document.getElementById('plotly-data-json');

            // Proceed only if both the chart div and JSON element are found
            if (chartDiv && plotlyJsonElement) {
                //Extract json string
                var plotlyJsonString = plotlyJsonElement.textContent;
                //If the string exists,
                if (plotlyJsonString) {
                    try {
                        //Turn json string into JavaScript object
                        var plotData = JSON.parse(plotlyJsonString);

                        // Check if plotData has the expected 'data' array and 'layout' object
                        if (plotData && plotData.data && plotData.layout) {
                            // Plot the chart at chartDiv with .data and .layout
                            Plotly.newPlot(chartDiv, plotData.data, plotData.layout);
                        } else {
                            // Display error if parsed data is incomplete
                            chartDiv.innerHTML = '<p style="color: red; text-align: center;">Error: Chart data is incomplete or malformed.</p>';
                        }
                    } catch (e) {
                        // Display error if JSON parsing fails
                        chartDiv.innerHTML = '<p style="color: red; text-align: center;">Error: Could not render chart. Invalid data format.</p>';
                        console.error("Error parsing Plotly JSON:", e);
                    }
                } else {
                    // Display message if no plot data is available
                    chartDiv.innerHTML = '<p class="text-muted text-center mt-5">No plot data available. Select variables and update the chart.</p>';
                }
            } else {
                console.error("Error: Required HTML elements (plotly-chart or plotly-data-json) not found.");
            }
        });
     </script>
{% endblock %}
